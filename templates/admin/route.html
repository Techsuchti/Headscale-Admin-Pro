<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Umfassende Demo der layui-Table-Komponente</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="/static/layui/css/layui.css" rel="stylesheet">
  <link href="/static/adminui/dist/css/admin.css" rel="stylesheet">
</head>
<body>


  
  <div class="layui-fluid">
    <div class="layui-row layui-col-space15">
      <div class="layui-col-md12">
        <div class="layui-card">
          <div class="layui-card-header">Routen-Zentrum</div>
          <div class="layui-card-body">
            <table class="layui-hide" id="test-table-index" lay-filter="test-table-index"></table>

            <script type="text/html" id="toolbarDemo">
              <div class="layui-btn-container">
                <button class="layui-btn layui-btn-sm" lay-event="reload">Aktualisieren</button>
                <button class="layui-btn layui-btn-sm" lay-event="add">Routen ank√ºndigen</button>
              </div>
            </script>
             

            {% raw %}
            <script type="text/html" id="test-table-switchTpl">
              <!-- Der checked-Status hier dient nur zur Demonstration -->
              <input type="checkbox" name="Aktivieren" lay-skin="switch" lay-text="Ja|Nein" lay-filter="test-table-sexDemo"
               value="{{ d.enable }}" data-json="{{ encodeURIComponent(JSON.stringify(d)) }}" {{ d.enable == "1" ? 'checked' : '' }}>
               &nbsp;
               <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">L√∂schen</a>
            </script>
            {% endraw %}
             

          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script src="/static/layui/layui.js"></script>
  <script>
  layui.config({
    base: '/static/' // Pfad, in dem sich die statischen Ressourcen befinden
  }).use(['index', 'table', 'dropdown','form'], function(){
    var table = layui.table
    ,form = layui.form
    ,$ = layui.$;
    var dropdown = layui.dropdown;
    
    // Render-Instanz erstellen
    table.render({
      elem: '#test-table-index'
      ,url: '/api/route/getRoute' // Hier: statisch simulierte Daten; in der Praxis durch echte API ersetzen
      ,toolbar: '#toolbarDemo'
      ,defaultToolbar: ['filter', 'exports', 'print', {
        title: 'Hilfe'
        ,layEvent: 'LAYTABLE_TIPS'
        ,icon: 'layui-icon-tips'
      }]
      ,height: 'full-100' // Maximale H√∂he minus der H√∂he anderer Container
      ,cellMinWidth: 80
      ,totalRow: true // Summenzeile aktivieren
      ,page: true
      ,cols: [[
            //{type: 'checkbox'}
            {field:'id', title:'ID', fixed: 'left', width:80, unresize: true, sort: true, totalRowText: 'Summe:'}
            {% if current_user.role == 'manager' %}
                ,{field:'name', title:'Benutzername',width:200, totalRow: '  {% raw %}{{= d.TOTAL_ROW.count   }}{% endraw %} üòä'}
            {% endif %}
            ,{field:'NodeName', title:'Knoten',width:300
                {% if current_user.role == 'user' %}
                    ,totalRow: ' {% raw %}{{= d.TOTAL_ROW.count   }}{% endraw %} üòä'
                {% endif %}
            }
            ,{field:'route', title:'Route',width:280}
            ,{field:'createTime', title: 'Erstellzeit', width:200, sort: true}
        
        ]]
      ,error: function(res, msg){
        console.log(res, msg)
      }
    });


   
// Toolbar-Events
table.on('toolbar(test-table-index)', function(obj){
  var $ = layui.$;
  var form = layui.form; // Sicherstellen, dass das form-Modul eingebunden ist
  var util = layui.util;
  var id = obj.config.id;
  var checkStatus = table.checkStatus(id);
  var othis = lay(this);
  switch(obj.event){
    case 'reload':
      var data = checkStatus.data;
      table.reload('test-table-index',true);
    break;
    case 'add':
       layer.open({
      type: 1,
      content: `
        <div class="layui-form" lay-filter="filter-test-layer" style="margin: 20px 35px 30px 0; padding: 10px 0;">
      <div class="demo-login-container">
        {% if current_user.role == 'manager' %}
        <!-- Benutzer-Auswahl Dropdown - nur f√ºr Admins sichtbar -->
        <div class="layui-form-item">
          <label class="layui-form-label">Benutzer ausw√§hlen</label>
          <div class="layui-input-block">
            <select name="userId" lay-verify="required" lay-reqtext="Bitte Benutzer ausw√§hlen" lay-filter="userIdFilter">
              <option value="">Wird geladen...</option>
            </select>
          </div>
        </div>
        {% endif %}
        
        <!-- Knoten-Auswahl Dropdown -->
        <div class="layui-form-item">
          <label class="layui-form-label">Knoten ausw√§hlen</label>
          <div class="layui-input-block">
            <select name="nodeId" lay-verify="required" lay-reqtext="Bitte Knoten ausw√§hlen" lay-filter="nodeIdFilter">
              <option value="">Wird geladen...</option>
            </select>
          </div>
        </div>
        
        <!-- Routen-Auswahl Dropdown -->
        <div class="layui-form-item">
          <label class="layui-form-label">Route ausw√§hlen</label>
          <div class="layui-input-block">
            <select name="routes" lay-verify="required" lay-reqtext="Bitte Route ausw√§hlen">
              <option value="">Bitte zuerst Knoten ausw√§hlen</option>
            </select>
          </div>
        </div>
      
        <div class="layui-form-item">
          <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="demo-login">Absenden</button>
          </div>
        </div>
      </div>
    </div>
      `,
  
      // Popup-H√∂he je nach Rolle anpassen (Admins haben zus√§tzlich die Benutzer-Auswahl, daher +50px)
      area: ['320px', {% if current_user.role == 'manager' %}'295px'{% else %}'245px'{% endif %}],
      maxmin: true,
      success: function(layero, index){
        layer.full(index); // Maximieren
        
        // Benutzerliste speichern (nur f√ºr Admins n√∂tig)
        var userList = [];
        // Aktueller Benutzer (f√ºr normale Benutzer)
        var currentUser = {
          id: '{{ current_user.id }}',
          username: '{{ current_user.username }}'
        };
        
        // Nur Admin: Benutzerliste laden
        {% if current_user.role == 'manager' %}
        $.ajax({
          url: '/api/user/getUsers', // API f√ºr Benutzerliste
          type: 'get',
          dataType: 'json',
          success: function(res) {
            if (res.code === "0" && res.data && res.data.length > 0) {
              userList = res.data;
              var userIdSelect = layero.find('select[name="userId"]');
              userIdSelect.html('<option value="">Bitte Benutzer ausw√§hlen</option>');
              res.data.forEach(function(user) {
                userIdSelect.append(`<option value="${user.id}">${user.userName}</option>`);
              });
            } else {
              layero.find('select[name="userId"]').html(`<option value="">${res.msg || 'Keine Benutzerdaten vorhanden'}</option>`);
            }
            form.render('select', 'filter-test-layer');
          },
          error: function(xhr) {
            console.error('Benutzer-Request fehlgeschlagen:', xhr);
            layero.find('select[name="userId"]').html('<option value="">Benutzerdaten konnten nicht geladen werden (Netzwerkfehler)</option>');
            form.render('select', 'filter-test-layer');
          }
        });
        {% endif %}
        
        // Knotenliste laden (Admins: nach Benutzerwahl; normale Benutzer: direkt)
        var loadNodes = function(userId, userName) {
          var nodeSelect = layero.find('select[name="nodeId"]');
          var routeSelect = layero.find('select[name="routes"]');
          
          // Knoten/Routen zur√ºcksetzen
          nodeSelect.html('<option value="">Knoten wird geladen...</option>');
          routeSelect.html('<option value="">Bitte zuerst Knoten ausw√§hlen</option>');
          form.render('select', 'filter-test-layer');
          
          // Knoten anfordern (Original-API beibehalten)
          $.ajax({
            url: '/api/node/getNodes',
            type: 'get',
            data: { 
              userId: userId,
              search_name: userName // Original-Parameterlogik beibehalten
            },
            dataType: 'json',
            success: function(res) {
              if (res.code === "0" && res.data && res.data.length > 0) {
                nodeSelect.html('<option value="">Bitte Knoten ausw√§hlen</option>');
                res.data.forEach(function(node) {
                  var displayText = `${node.name} (${node.ip})`;
                  nodeSelect.append(`<option value="${node.id}">${displayText}</option>`);
                });
              } else {
                nodeSelect.html(`<option value="">${res.msg || 'Dieser Benutzer hat keine verf√ºgbaren Knoten'}</option>`);
              }
              form.render('select', 'filter-test-layer');
            },
            error: function(xhr) {
              console.error('Knoten-Request fehlgeschlagen:', xhr);
              nodeSelect.html('<option value="">Knotendaten konnten nicht geladen werden (Netzwerkfehler)</option>');
              form.render('select', 'filter-test-layer');
            }
          });
        };
        
        // Admin: Benutzerwechsel √ºberwachen
        {% if current_user.role == 'manager' %}
        form.on('select(userIdFilter)', function(data){
          var userId = data.value;
          if (!userId) {
            layero.find('select[name="nodeId"]').html('<option value="">Bitte zuerst Benutzer ausw√§hlen</option>');
            form.render('select', 'filter-test-layer');
            return;
          }
          // Benutzername anhand userId finden
          var userName = '';
          for (var i = 0; i < userList.length; i++) {
            if (userList[i].id == userId) {
              userName = userList[i].userName;
              break;
            }
          }
          loadNodes(userId, userName);
        });
        {% else %}
        // Normaler Benutzer: eigene Knoten direkt laden
        loadNodes(currentUser.id, currentUser.username);
        {% endif %}
        
        // Knoten-Auswahl √ºberwachen (Original-Logik beibehalten)
        form.on('select(nodeIdFilter)', function(data){
          var nodeId = data.value;
          var routesSelect = layero.find('select[name="routes"]');
          
          if (!nodeId) {
            routesSelect.html('<option value="">Bitte zuerst Knoten ausw√§hlen</option>');
            form.render('select', 'filter-test-layer');
            return;
          }
          
          routesSelect.html('<option value="">Routen werden geladen...</option>');
          form.render('select', 'filter-test-layer');
          
          $.ajax({
            url: '/api/node/node_route_info',
            type: 'post',
            data: { NodeId: nodeId },
            dataType: 'json',
            success: function(routeRes) {
              if (routeRes.code === "0" && routeRes.data && routeRes.data.length > 0) {
                var availableRoutes = routeRes.data[0].availableRoutes || [];
                if (availableRoutes.length > 0) {
                  routesSelect.html('<option value="">Bitte Route ausw√§hlen, die angek√ºndigt werden soll</option>');
                  availableRoutes.forEach(function(route) {
                    routesSelect.append(`<option value="${route}">${route}</option>`);
                  });
                } else {
                  routesSelect.html('<option value="">Dieser Knoten hat keine verf√ºgbaren Routen</option>');
                }
              } else {
                routesSelect.html(`<option value="">${routeRes.msg || 'Abruf der Routendaten fehlgeschlagen'}</option>`);
              }
              form.render('select', 'filter-test-layer');
            },
            error: function(xhr) {
              console.error('Routen-Request fehlgeschlagen:', xhr);
              routesSelect.html('<option value="">Routen konnten nicht geladen werden (Netzwerkfehler)</option>');
              form.render('select', 'filter-test-layer');
            }
          });
        });
        
        // Formular-Submit √ºberwachen (Original-Logik beibehalten)
        form.on('submit(demo-login)', function(data) {
          // Normaler Benutzer: userId erg√§nzen
          {% if current_user.role != 'manager' %}
          data.field.userId = currentUser.id;
          {% endif %}
          
          $.ajax({
            url: '/api/node/approve_routes',
            type: 'post',
            data: data.field,
            success: function(res) {
              if (res.code === "0") {
                layer.msg(res.msg, {icon: 6});
                layer.close(index);
                table.reload('test-table-index');
              } else {
                layer.msg(res.msg || 'Vorgang fehlgeschlagen', {icon: 7});
              }
            }
          });
          
          return false;
        });
      }
    });

    break;
  };
});
   

  });
  </script>
</body>
</html>
